# EKS Development - Cost Optimized Configuration
# Designed for t3.small SPOT instances with 1-3 nodes
# This configuration starts minimal and scales based on actual load

environment: Development

# Use ECR images
gateway:
  enabled: true
  replicaCount: 1  # Start with 1, HPA will scale
  image:
    repository: 215958754319.dkr.ecr.us-east-1.amazonaws.com/toskamesh-eks-services
    tag: gateway-latest
    pullPolicy: Always
  service:
    type: LoadBalancer
    port: 80
    annotations:
      service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
  resources:
    requests:
      cpu: 100m  # Reduced for cost optimization
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi
  hpa:
    enabled: true
    minReplicas: 1  # Start minimal
    maxReplicas: 3
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80
  secrets:
    jwtSecretKey: "dev-jwt-secret-key-change-in-production-min-32-chars-long"

discovery:
  enabled: true
  replicaCount: 1
  image:
    repository: 215958754319.dkr.ecr.us-east-1.amazonaws.com/toskamesh-eks-services
    tag: discovery-latest
    pullPolicy: Always
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi
  hpa:
    enabled: true
    minReplicas: 1
    maxReplicas: 3
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80

authService:
  enabled: true
  replicaCount: 1
  image:
    repository: 215958754319.dkr.ecr.us-east-1.amazonaws.com/toskamesh-eks-services
    tag: auth-service-latest
    pullPolicy: Always
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 250m
      memory: 256Mi
  hpa:
    enabled: true
    minReplicas: 1
    maxReplicas: 2
    targetCPUUtilizationPercentage: 70

configService:
  enabled: true
  replicaCount: 1
  image:
    repository: 215958754319.dkr.ecr.us-east-1.amazonaws.com/toskamesh-eks-services
    tag: config-service-latest
    pullPolicy: Always
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 250m
      memory: 256Mi
  hpa:
    enabled: true
    minReplicas: 1
    maxReplicas: 2
    targetCPUUtilizationPercentage: 70

metricsService:
  enabled: true
  replicaCount: 1
  image:
    repository: 215958754319.dkr.ecr.us-east-1.amazonaws.com/toskamesh-eks-services
    tag: metrics-service-latest
    pullPolicy: Always
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 250m
      memory: 256Mi
  hpa:
    enabled: true
    minReplicas: 1
    maxReplicas: 2
    targetCPUUtilizationPercentage: 70

tracingService:
  enabled: true
  replicaCount: 1
  image:
    repository: 215958754319.dkr.ecr.us-east-1.amazonaws.com/toskamesh-eks-services
    tag: tracing-service-latest
    pullPolicy: Always
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 250m
      memory: 256Mi
  hpa:
    enabled: true
    minReplicas: 1
    maxReplicas: 2
    targetCPUUtilizationPercentage: 70

core:
  enabled: true
  replicaCount: 1  # Orleans can run with 1 silo for dev
  image:
    repository: 215958754319.dkr.ecr.us-east-1.amazonaws.com/toskamesh-eks-services
    tag: core-latest
    pullPolicy: Always
  orleans:
    serviceName: "ToskaMesh-Dev"
    clusterId: "dev-eks"
  resources:
    requests:
      cpu: 200m  # Core needs more resources
      memory: 256Mi
    limits:
      cpu: 1000m
      memory: 1Gi
  hpa:
    enabled: true
    minReplicas: 1
    maxReplicas: 3
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80

healthMonitor:
  enabled: true
  replicaCount: 1
  image:
    repository: 215958754319.dkr.ecr.us-east-1.amazonaws.com/toskamesh-eks-services
    tag: health-monitor-latest
    pullPolicy: Always
  resources:
    requests:
      cpu: 25m
      memory: 32Mi
    limits:
      cpu: 100m
      memory: 128Mi
  hpa:
    enabled: false  # Health monitor doesn't need HPA

# External services - In-cluster deployment for development
externalServices:
  consul:
    address: "http://consul-server.toskamesh-infra.svc.cluster.local:8500"
  postgres:
    host: "postgres-postgresql.toskamesh-infra.svc.cluster.local"
    port: 5432
    database: "toksa_mesh"
    username: "toksa_mesh"
    password: "toksa_mesh_password"
  rabbitmq:
    host: "rabbitmq.toskamesh-infra.svc.cluster.local"
    port: 5672
    username: "guest"
    password: "guest"
  redis:
    host: "redis-master.toskamesh-infra.svc.cluster.local"
    port: 6379

# Global secrets
global:
  meshServiceAuthSecret: "dev-mesh-service-auth-secret-change-me"

# Service Account
serviceAccount:
  create: true
  annotations: {}
  name: "toskamesh"

# Service mesh (disabled for cost optimization)
mesh:
  enabled: false

# Resource Summary (Initial Deployment - 1 replica each):
# Total Requests: ~625m CPU, ~735Mi RAM
# Fits comfortably on 1 Ã— t3.small (1.6 vCPU allocatable, 1.4Gi RAM)
# HPA will scale up and trigger node autoscaling as needed
